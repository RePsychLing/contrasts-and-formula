<!DOCTYPE html>
<HTML lang = "en">
<HEAD>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  
  

  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      TeX: { equationNumbers: { autoNumber: "AMS" } }
    });
  </script>

  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>

  
<style>
pre.hljl {
    border: 1px solid #ccc;
    margin: 5px;
    padding: 5px;
    overflow-x: auto;
    color: rgb(68,68,68); background-color: rgb(251,251,251); }
pre.hljl > span.hljl-t { }
pre.hljl > span.hljl-w { }
pre.hljl > span.hljl-e { }
pre.hljl > span.hljl-eB { }
pre.hljl > span.hljl-o { }
pre.hljl > span.hljl-k { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kc { color: rgb(59,151,46); font-style: italic; }
pre.hljl > span.hljl-kd { color: rgb(214,102,97); font-style: italic; }
pre.hljl > span.hljl-kn { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kp { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kr { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kt { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-n { }
pre.hljl > span.hljl-na { }
pre.hljl > span.hljl-nb { }
pre.hljl > span.hljl-nbp { }
pre.hljl > span.hljl-nc { }
pre.hljl > span.hljl-ncB { }
pre.hljl > span.hljl-nd { color: rgb(214,102,97); }
pre.hljl > span.hljl-ne { }
pre.hljl > span.hljl-neB { }
pre.hljl > span.hljl-nf { color: rgb(66,102,213); }
pre.hljl > span.hljl-nfm { color: rgb(66,102,213); }
pre.hljl > span.hljl-np { }
pre.hljl > span.hljl-nl { }
pre.hljl > span.hljl-nn { }
pre.hljl > span.hljl-no { }
pre.hljl > span.hljl-nt { }
pre.hljl > span.hljl-nv { }
pre.hljl > span.hljl-nvc { }
pre.hljl > span.hljl-nvg { }
pre.hljl > span.hljl-nvi { }
pre.hljl > span.hljl-nvm { }
pre.hljl > span.hljl-l { }
pre.hljl > span.hljl-ld { color: rgb(148,91,176); font-style: italic; }
pre.hljl > span.hljl-s { color: rgb(201,61,57); }
pre.hljl > span.hljl-sa { color: rgb(201,61,57); }
pre.hljl > span.hljl-sb { color: rgb(201,61,57); }
pre.hljl > span.hljl-sc { color: rgb(201,61,57); }
pre.hljl > span.hljl-sd { color: rgb(201,61,57); }
pre.hljl > span.hljl-sdB { color: rgb(201,61,57); }
pre.hljl > span.hljl-sdC { color: rgb(201,61,57); }
pre.hljl > span.hljl-se { color: rgb(59,151,46); }
pre.hljl > span.hljl-sh { color: rgb(201,61,57); }
pre.hljl > span.hljl-si { }
pre.hljl > span.hljl-so { color: rgb(201,61,57); }
pre.hljl > span.hljl-sr { color: rgb(201,61,57); }
pre.hljl > span.hljl-ss { color: rgb(201,61,57); }
pre.hljl > span.hljl-ssB { color: rgb(201,61,57); }
pre.hljl > span.hljl-nB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nbB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nfB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nh { color: rgb(59,151,46); }
pre.hljl > span.hljl-ni { color: rgb(59,151,46); }
pre.hljl > span.hljl-nil { color: rgb(59,151,46); }
pre.hljl > span.hljl-noB { color: rgb(59,151,46); }
pre.hljl > span.hljl-oB { color: rgb(102,102,102); font-weight: bold; }
pre.hljl > span.hljl-ow { color: rgb(102,102,102); font-weight: bold; }
pre.hljl > span.hljl-p { }
pre.hljl > span.hljl-c { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-ch { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cm { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cp { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cpB { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cs { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-csB { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-g { }
pre.hljl > span.hljl-gd { }
pre.hljl > span.hljl-ge { }
pre.hljl > span.hljl-geB { }
pre.hljl > span.hljl-gh { }
pre.hljl > span.hljl-gi { }
pre.hljl > span.hljl-go { }
pre.hljl > span.hljl-gp { }
pre.hljl > span.hljl-gs { }
pre.hljl > span.hljl-gsB { }
pre.hljl > span.hljl-gt { }
</style>



  <style type="text/css">
  @font-face {
  font-style: normal;
  font-weight: 300;
}
@font-face {
  font-style: normal;
  font-weight: 400;
}
@font-face {
  font-style: normal;
  font-weight: 600;
}
html {
  font-family: sans-serif; /* 1 */
  -ms-text-size-adjust: 100%; /* 2 */
  -webkit-text-size-adjust: 100%; /* 2 */
}
body {
  margin: 0;
}
article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
menu,
nav,
section,
summary {
  display: block;
}
audio,
canvas,
progress,
video {
  display: inline-block; /* 1 */
  vertical-align: baseline; /* 2 */
}
audio:not([controls]) {
  display: none;
  height: 0;
}
[hidden],
template {
  display: none;
}
a:active,
a:hover {
  outline: 0;
}
abbr[title] {
  border-bottom: 1px dotted;
}
b,
strong {
  font-weight: bold;
}
dfn {
  font-style: italic;
}
h1 {
  font-size: 2em;
  margin: 0.67em 0;
}
mark {
  background: #ff0;
  color: #000;
}
small {
  font-size: 80%;
}
sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
sup {
  top: -0.5em;
}
sub {
  bottom: -0.25em;
}
img {
  border: 0;
}
svg:not(:root) {
  overflow: hidden;
}
figure {
  margin: 1em 40px;
}
hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}
pre {
  overflow: auto;
}
code,
kbd,
pre,
samp {
  font-family: monospace, monospace;
  font-size: 1em;
}
button,
input,
optgroup,
select,
textarea {
  color: inherit; /* 1 */
  font: inherit; /* 2 */
  margin: 0; /* 3 */
}
button {
  overflow: visible;
}
button,
select {
  text-transform: none;
}
button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
  -webkit-appearance: button; /* 2 */
  cursor: pointer; /* 3 */
}
button[disabled],
html input[disabled] {
  cursor: default;
}
button::-moz-focus-inner,
input::-moz-focus-inner {
  border: 0;
  padding: 0;
}
input {
  line-height: normal;
}
input[type="checkbox"],
input[type="radio"] {
  box-sizing: border-box; /* 1 */
  padding: 0; /* 2 */
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  height: auto;
}
input[type="search"] {
  -webkit-appearance: textfield; /* 1 */
  -moz-box-sizing: content-box;
  -webkit-box-sizing: content-box; /* 2 */
  box-sizing: content-box;
}
input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
  -webkit-appearance: none;
}
fieldset {
  border: 1px solid #c0c0c0;
  margin: 0 2px;
  padding: 0.35em 0.625em 0.75em;
}
legend {
  border: 0; /* 1 */
  padding: 0; /* 2 */
}
textarea {
  overflow: auto;
}
optgroup {
  font-weight: bold;
}
table {
  font-family: monospace, monospace;
  font-size : 0.8em;
  border-collapse: collapse;
  border-spacing: 0;
}
td,
th {
  padding: 0;
}
thead th {
    border-bottom: 1px solid black;
    background-color: white;
}
tr:nth-child(odd){
  background-color: rgb(248,248,248);
}


/*
* Skeleton V2.0.4
* Copyright 2014, Dave Gamache
* www.getskeleton.com
* Free to use under the MIT license.
* http://www.opensource.org/licenses/mit-license.php
* 12/29/2014
*/
.container {
  position: relative;
  width: 100%;
  max-width: 960px;
  margin: 0 auto;
  padding: 0 20px;
  box-sizing: border-box; }
.column,
.columns {
  width: 100%;
  float: left;
  box-sizing: border-box; }
@media (min-width: 400px) {
  .container {
    width: 85%;
    padding: 0; }
}
@media (min-width: 550px) {
  .container {
    width: 80%; }
  .column,
  .columns {
    margin-left: 4%; }
  .column:first-child,
  .columns:first-child {
    margin-left: 0; }

  .one.column,
  .one.columns                    { width: 4.66666666667%; }
  .two.columns                    { width: 13.3333333333%; }
  .three.columns                  { width: 22%;            }
  .four.columns                   { width: 30.6666666667%; }
  .five.columns                   { width: 39.3333333333%; }
  .six.columns                    { width: 48%;            }
  .seven.columns                  { width: 56.6666666667%; }
  .eight.columns                  { width: 65.3333333333%; }
  .nine.columns                   { width: 74.0%;          }
  .ten.columns                    { width: 82.6666666667%; }
  .eleven.columns                 { width: 91.3333333333%; }
  .twelve.columns                 { width: 100%; margin-left: 0; }

  .one-third.column               { width: 30.6666666667%; }
  .two-thirds.column              { width: 65.3333333333%; }

  .one-half.column                { width: 48%; }

  /* Offsets */
  .offset-by-one.column,
  .offset-by-one.columns          { margin-left: 8.66666666667%; }
  .offset-by-two.column,
  .offset-by-two.columns          { margin-left: 17.3333333333%; }
  .offset-by-three.column,
  .offset-by-three.columns        { margin-left: 26%;            }
  .offset-by-four.column,
  .offset-by-four.columns         { margin-left: 34.6666666667%; }
  .offset-by-five.column,
  .offset-by-five.columns         { margin-left: 43.3333333333%; }
  .offset-by-six.column,
  .offset-by-six.columns          { margin-left: 52%;            }
  .offset-by-seven.column,
  .offset-by-seven.columns        { margin-left: 60.6666666667%; }
  .offset-by-eight.column,
  .offset-by-eight.columns        { margin-left: 69.3333333333%; }
  .offset-by-nine.column,
  .offset-by-nine.columns         { margin-left: 78.0%;          }
  .offset-by-ten.column,
  .offset-by-ten.columns          { margin-left: 86.6666666667%; }
  .offset-by-eleven.column,
  .offset-by-eleven.columns       { margin-left: 95.3333333333%; }

  .offset-by-one-third.column,
  .offset-by-one-third.columns    { margin-left: 34.6666666667%; }
  .offset-by-two-thirds.column,
  .offset-by-two-thirds.columns   { margin-left: 69.3333333333%; }

  .offset-by-one-half.column,
  .offset-by-one-half.columns     { margin-left: 52%; }

}
html {
  font-size: 62.5%; }
body {
  font-size: 1.5em; /* currently ems cause chrome bug misinterpreting rems on body element */
  line-height: 1.6;
  font-weight: 400;
  font-family: "Raleway", "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
  color: #222; }
h1, h2, h3, h4, h5, h6 {
  margin-top: 0;
  margin-bottom: 2rem;
  font-weight: 300; }
h1 { font-size: 3.6rem; line-height: 1.2;  letter-spacing: -.1rem;}
h2 { font-size: 3.4rem; line-height: 1.25; letter-spacing: -.1rem; }
h3 { font-size: 3.2rem; line-height: 1.3;  letter-spacing: -.1rem; }
h4 { font-size: 2.8rem; line-height: 1.35; letter-spacing: -.08rem; }
h5 { font-size: 2.4rem; line-height: 1.5;  letter-spacing: -.05rem; }
h6 { font-size: 1.5rem; line-height: 1.6;  letter-spacing: 0; }

p {
  margin-top: 0; }
a {
  color: #1EAEDB; }
a:hover {
  color: #0FA0CE; }
.button,
button,
input[type="submit"],
input[type="reset"],
input[type="button"] {
  display: inline-block;
  height: 38px;
  padding: 0 30px;
  color: #555;
  text-align: center;
  font-size: 11px;
  font-weight: 600;
  line-height: 38px;
  letter-spacing: .1rem;
  text-transform: uppercase;
  text-decoration: none;
  white-space: nowrap;
  background-color: transparent;
  border-radius: 4px;
  border: 1px solid #bbb;
  cursor: pointer;
  box-sizing: border-box; }
.button:hover,
button:hover,
input[type="submit"]:hover,
input[type="reset"]:hover,
input[type="button"]:hover,
.button:focus,
button:focus,
input[type="submit"]:focus,
input[type="reset"]:focus,
input[type="button"]:focus {
  color: #333;
  border-color: #888;
  outline: 0; }
.button.button-primary,
button.button-primary,
input[type="submit"].button-primary,
input[type="reset"].button-primary,
input[type="button"].button-primary {
  color: #FFF;
  background-color: #33C3F0;
  border-color: #33C3F0; }
.button.button-primary:hover,
button.button-primary:hover,
input[type="submit"].button-primary:hover,
input[type="reset"].button-primary:hover,
input[type="button"].button-primary:hover,
.button.button-primary:focus,
button.button-primary:focus,
input[type="submit"].button-primary:focus,
input[type="reset"].button-primary:focus,
input[type="button"].button-primary:focus {
  color: #FFF;
  background-color: #1EAEDB;
  border-color: #1EAEDB; }
input[type="email"],
input[type="number"],
input[type="search"],
input[type="text"],
input[type="tel"],
input[type="url"],
input[type="password"],
textarea,
select {
  height: 38px;
  padding: 6px 10px; /* The 6px vertically centers text on FF, ignored by Webkit */
  background-color: #fff;
  border: 1px solid #D1D1D1;
  border-radius: 4px;
  box-shadow: none;
  box-sizing: border-box; }
/* Removes awkward default styles on some inputs for iOS */
input[type="email"],
input[type="number"],
input[type="search"],
input[type="text"],
input[type="tel"],
input[type="url"],
input[type="password"],
textarea {
  -webkit-appearance: none;
     -moz-appearance: none;
          appearance: none; }
textarea {
  min-height: 65px;
  padding-top: 6px;
  padding-bottom: 6px; }
input[type="email"]:focus,
input[type="number"]:focus,
input[type="search"]:focus,
input[type="text"]:focus,
input[type="tel"]:focus,
input[type="url"]:focus,
input[type="password"]:focus,
textarea:focus,
select:focus {
  border: 1px solid #33C3F0;
  outline: 0; }
label,
legend {
  display: block;
  margin-bottom: .5rem;
  font-weight: 600; }
fieldset {
  padding: 0;
  border-width: 0; }
input[type="checkbox"],
input[type="radio"] {
  display: inline; }
label > .label-body {
  display: inline-block;
  margin-left: .5rem;
  font-weight: normal; }
ul {
  list-style: circle; }
ol {
  list-style: decimal; }
ul ul,
ul ol,
ol ol,
ol ul {
  margin: 1.5rem 0 1.5rem 3rem;
  font-size: 90%; }
li > p {margin : 0;}
th,
td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid #E1E1E1; }
th:first-child,
td:first-child {
  padding-left: 0; }
th:last-child,
td:last-child {
  padding-right: 0; }
button,
.button {
  margin-bottom: 1rem; }
input,
textarea,
select,
fieldset {
  margin-bottom: 1.5rem; }
pre,
blockquote,
dl,
figure,
table,
p,
ul,
ol,
form {
  margin-bottom: 1.0rem; }
.u-full-width {
  width: 100%;
  box-sizing: border-box; }
.u-max-full-width {
  max-width: 100%;
  box-sizing: border-box; }
.u-pull-right {
  float: right; }
.u-pull-left {
  float: left; }
hr {
  margin-top: 3rem;
  margin-bottom: 3.5rem;
  border-width: 0;
  border-top: 1px solid #E1E1E1; }
.container:after,
.row:after,
.u-cf {
  content: "";
  display: table;
  clear: both; }

pre {
  display: block;
  padding: 9.5px;
  margin: 0 0 10px;
  font-size: 13px;
  line-height: 1.42857143;
  word-break: break-all;
  word-wrap: break-word;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre.hljl {
  margin: 0 0 10px;
  display: block;
  background: #f5f5f5;
  border-radius: 4px;
  padding : 5px;
}

pre.output {
  background: #ffffff;
}

pre.code {
  background: #ffffff;
}

pre.julia-error {
  color : red
}

code,
kbd,
pre,
samp {
  font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
  font-size: 13px;
}


@media (min-width: 400px) {}
@media (min-width: 550px) {}
@media (min-width: 750px) {}
@media (min-width: 1000px) {}
@media (min-width: 1200px) {}

h1.title {margin-top : 20px}
img {max-width : 100%}
div.title {text-align: center;}

  </style>



</HEAD>
  <BODY>
    <div class ="container">
      <div class = "row">
        <div class = "col-md-12 twelve columns">

          <div class="title">
            
            
            
          </div>

          <hr />
<p>title: A quick tour of StatsModels.jl subtitle: Contrast coding, <code>@formula</code>, and Terms author: Dave Kleinschmidt date: 18 February 2020 ...</p>
<h1>Contrast coding</h1>
<h2>What and why?</h2>
<p>To fit any kind of statistical model you need some kind of <em>numerical representation</em> of your data. Data often comes in a <em>table</em>, a named collection of variables of different types of data. Some of that data is &quot;continuous&quot;, or basically numeric. But often our data is not numeric &#40;or continuous&#41;, but &quot;categorical&quot;, having a finite number of distinct levels.</p>
<p>For instance, let&#39;s look at the KB07 dataset:</p>


<pre class='hljl'>
<span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>DataFrames</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>DataFramesMeta</span><span class='hljl-t'>
</span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>MixedModels</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>GLM</span><span class='hljl-t'>
</span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>LinearAlgebra</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Statistics</span><span class='hljl-t'>

</span><span class='hljl-n'>kb07</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>MixedModels</span><span class='hljl-oB'>.</span><span class='hljl-nf'>dataset</span><span class='hljl-p'>(</span><span class='hljl-sc'>:kb07</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>first</span><span class='hljl-p'>(</span><span class='hljl-n'>kb07</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>5</span><span class='hljl-p'>)</span>
</pre>



<table class="data-frame"><thead><tr><th></th><th>subj</th><th>item</th><th>spkr</th><th>prec</th><th>load</th><th>rt_trunc</th><th>rt_raw</th></tr><tr><th></th><th>String</th><th>String</th><th>String</th><th>String</th><th>String</th><th>Int16</th><th>Int16</th></tr></thead><tbody><p>5 rows × 7 columns</p><tr><th>1</th><td>S030</td><td>I01</td><td>new</td><td>break</td><td>yes</td><td>2267</td><td>2267</td></tr><tr><th>2</th><td>S030</td><td>I02</td><td>old</td><td>maintain</td><td>no</td><td>3856</td><td>3856</td></tr><tr><th>3</th><td>S030</td><td>I03</td><td>old</td><td>break</td><td>no</td><td>1567</td><td>1567</td></tr><tr><th>4</th><td>S030</td><td>I04</td><td>new</td><td>maintain</td><td>no</td><td>1732</td><td>1732</td></tr><tr><th>5</th><td>S030</td><td>I05</td><td>new</td><td>break</td><td>no</td><td>2660</td><td>2660</td></tr></tbody></table>

<p>Here <code>:spkr</code>, <code>:prec</code>, and <code>:load</code> are categortical variables, each of which takes on two different values. If we fit a regression using this dataset, we end up with predictors that refer to specific levels:</p>


<pre class='hljl'>
<span class='hljl-n'>f</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nd'>@formula</span><span class='hljl-p'>(</span><span class='hljl-n'>rt_trunc</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>spkr</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>prec</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>spkr</span><span class='hljl-oB'>&amp;</span><span class='hljl-n'>prec</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>|</span><span class='hljl-t'> </span><span class='hljl-n'>subj</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-n'>mod</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>fit</span><span class='hljl-p'>(</span><span class='hljl-n'>MixedModel</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>f</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>kb07</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
Linear mixed model fit by maximum likelihood
 rt_trunc ~ 1 &#43; spkr &#43; prec &#43; spkr &amp; prec &#43; &#40;1 | subj&#41;
     logLik        -2 logLik          AIC             BIC       
 -1.45767208×10⁴  2.91534417×10⁴  2.91654417×10⁴  2.91983781×10⁴

Variance components:
            Column    Variance  Std.Dev. 
subj     &#40;Intercept&#41;   95885.39 309.65366
Residual              662657.47 814.03776
 Number of obs: 1789; levels of grouping factors: 56

  Fixed-effects parameters:
──────────────────────────────────────────────────────────────────
                             Estimate  Std.Error  z value  P&#40;&gt;|z|&#41;
──────────────────────────────────────────────────────────────────
&#40;Intercept&#41;                 2425.32      56.5224    42.91   &lt;1e-99
spkr: old                    179.992     54.4214     3.31   0.0009
prec: maintain              -623.347     54.4214   -11.45   &lt;1e-29
spkr: old &amp; prec: maintain   -86.7763    76.9856    -1.13   0.2597
──────────────────────────────────────────────────────────────────
</pre>


<p>Let&#39;s look at a few rows of the fixed effects design matrix that&#39;s generated for this model:</p>


<pre class='hljl'>
<span class='hljl-n'>Int</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-n'>mod</span><span class='hljl-oB'>.</span><span class='hljl-n'>X</span><span class='hljl-p'>)[</span><span class='hljl-ni'>1</span><span class='hljl-oB'>:</span><span class='hljl-ni'>5</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-oB'>:</span><span class='hljl-p'>]</span>
</pre>


<pre class="output">
5×4 Array&#123;Int64,2&#125;:
 1  0  0  0
 1  1  1  1
 1  1  0  0
 1  0  1  0
 1  0  0  0
</pre>


<p>A few things to note: all the values are 0 or 1, and there&#39;s one column of all 1s at the start &#40;that&#39;s the <code>&#40;Intercept&#41;</code> term&#41;. Columns 2 and 3 correspond to <code>spkr</code> and <code>prec</code>: there&#39;s a 0 where <code>spkr &#61;&#61; &quot;new&quot;</code> and a 1 for <code>&quot;old&quot;</code>. Note that the coefficient name for this column is <code>spkr: old</code>, which indicates that this predictor indicates the presence of &quot;old&quot;, relative to the &#40;implicit&#41; baseline of &quot;new&quot;. Similarly for <code>prec: maintain</code>.</p>
<p>The last column is the interaction term <code>spkr&amp;prec</code>, and it&#39;s the elementwise product of the columns for <code>spkr: new</code> and <code>pred: maintain</code>.</p>


<pre class='hljl'>
<span class='hljl-n'>kb07</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-oB'>:</span><span class='hljl-ni'>5</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-oB'>:</span><span class='hljl-p'>]</span>
</pre>



<table class="data-frame"><thead><tr><th></th><th>subj</th><th>item</th><th>spkr</th><th>prec</th><th>load</th><th>rt_trunc</th><th>rt_raw</th></tr><tr><th></th><th>String</th><th>String</th><th>String</th><th>String</th><th>String</th><th>Int16</th><th>Int16</th></tr></thead><tbody><p>5 rows × 7 columns</p><tr><th>1</th><td>S030</td><td>I01</td><td>new</td><td>break</td><td>yes</td><td>2267</td><td>2267</td></tr><tr><th>2</th><td>S030</td><td>I02</td><td>old</td><td>maintain</td><td>no</td><td>3856</td><td>3856</td></tr><tr><th>3</th><td>S030</td><td>I03</td><td>old</td><td>break</td><td>no</td><td>1567</td><td>1567</td></tr><tr><th>4</th><td>S030</td><td>I04</td><td>new</td><td>maintain</td><td>no</td><td>1732</td><td>1732</td></tr><tr><th>5</th><td>S030</td><td>I05</td><td>new</td><td>break</td><td>no</td><td>2660</td><td>2660</td></tr></tbody></table>

<h2>How to take control</h2>
<p>You can set your own contrasts via the <code>contrasts&#61;</code> keyword argument in <code>fit</code>, with the variable you want to code as the key and contrasts as the value:</p>


<pre class='hljl'>
<span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>StatsModels</span><span class='hljl-t'>

</span><span class='hljl-n'>contrasts</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Dict</span><span class='hljl-p'>(</span><span class='hljl-t'>
    </span><span class='hljl-sc'>:spkr</span><span class='hljl-t'> </span><span class='hljl-oB'>=&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>EffectsCoding</span><span class='hljl-p'>(</span><span class='hljl-n'>base</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;old&quot;</span><span class='hljl-p'>),</span><span class='hljl-t'>
    </span><span class='hljl-sc'>:prec</span><span class='hljl-t'> </span><span class='hljl-oB'>=&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>DummyCoding</span><span class='hljl-p'>(</span><span class='hljl-n'>levels</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-s'>&quot;maintain&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;break&quot;</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-p'>)</span><span class='hljl-t'>

</span><span class='hljl-n'>mod2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>fit</span><span class='hljl-p'>(</span><span class='hljl-n'>MixedModel</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>f</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>kb07</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>contrasts</span><span class='hljl-oB'>=</span><span class='hljl-n'>contrasts</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
Linear mixed model fit by maximum likelihood
 rt_trunc ~ 1 &#43; spkr &#43; prec &#43; spkr &amp; prec &#43; &#40;1 | subj&#41;
     logLik        -2 logLik          AIC             BIC       
 -1.45767208×10⁴  2.91534417×10⁴  2.91654417×10⁴  2.91983781×10⁴

Variance components:
            Column    Variance  Std.Dev. 
subj     &#40;Intercept&#41;   95885.39 309.65366
Residual              662657.47 814.03776
 Number of obs: 1789; levels of grouping factors: 56

  Fixed-effects parameters:
───────────────────────────────────────────────────────────────
                          Estimate  Std.Error  z value  P&#40;&gt;|z|&#41;
───────────────────────────────────────────────────────────────
&#40;Intercept&#41;              1848.58      49.5329    37.32   &lt;1e-99
spkr: new                 -46.6081    27.2263    -1.71   0.0869
prec: break               666.735     38.4928    17.32   &lt;1e-66
spkr: new &amp; prec: break   -43.3882    38.4928    -1.13   0.2597
───────────────────────────────────────────────────────────────
</pre>


<p>This example illustrates two ways to control the ordering of levels used to compute the contrasts:</p>
<ol>
<li><p>you can use <code>base&#61;</code> to determine the baseline level</p>
</li>
<li><p>you can use <code>levels&#61;</code> to indicate all the levels that are used in  the contrasts, the first of which is automatically set as the  baseline.</p>
</li>
</ol>
<h3>Reversed Helmert coding</h3>
<p>Let&#39;s say you want to use reverse Helmert coding.  It&#39;s easy using <code>reverse</code> to flip the order of the levels.  Here&#39;s the original:</p>


<pre class='hljl'>
<span class='hljl-n'>spkr_levels</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-s'>&quot;old&quot;</span><span class='hljl-p'>,</span><span class='hljl-s'>&quot;new&quot;</span><span class='hljl-p'>]</span><span class='hljl-t'>
</span><span class='hljl-nf'>fit</span><span class='hljl-p'>(</span><span class='hljl-n'>MixedModel</span><span class='hljl-p'>,</span><span class='hljl-t'>
    </span><span class='hljl-n'>f</span><span class='hljl-p'>,</span><span class='hljl-t'>
    </span><span class='hljl-n'>kb07</span><span class='hljl-p'>,</span><span class='hljl-t'>
    </span><span class='hljl-n'>contrasts</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Dict</span><span class='hljl-p'>(</span><span class='hljl-sc'>:spkr</span><span class='hljl-t'> </span><span class='hljl-oB'>=&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>HelmertCoding</span><span class='hljl-p'>(</span><span class='hljl-n'>levels</span><span class='hljl-oB'>=</span><span class='hljl-n'>spkr_levels</span><span class='hljl-p'>)))</span>
</pre>


<pre class="output">
Linear mixed model fit by maximum likelihood
 rt_trunc ~ 1 &#43; spkr &#43; prec &#43; spkr &amp; prec &#43; &#40;1 | subj&#41;
     logLik        -2 logLik          AIC             BIC       
 -1.45767208×10⁴  2.91534417×10⁴  2.91654417×10⁴  2.91983781×10⁴

Variance components:
            Column    Variance  Std.Dev. 
subj     &#40;Intercept&#41;   95885.39 309.65366
Residual              662657.47 814.03776
 Number of obs: 1789; levels of grouping factors: 56

  Fixed-effects parameters:
──────────────────────────────────────────────────────────────────
                             Estimate  Std.Error  z value  P&#40;&gt;|z|&#41;
──────────────────────────────────────────────────────────────────
&#40;Intercept&#41;                 2515.31      49.5243    50.79   &lt;1e-99
spkr: new                    -89.9962    27.2107    -3.31   0.0009
prec: maintain              -666.735     38.4928   -17.32   &lt;1e-66
spkr: new &amp; prec: maintain    43.3882    38.4928     1.13   0.2597
──────────────────────────────────────────────────────────────────
</pre>


<p>And reversed:</p>


<pre class='hljl'>
<span class='hljl-nf'>fit</span><span class='hljl-p'>(</span><span class='hljl-n'>MixedModel</span><span class='hljl-p'>,</span><span class='hljl-t'>
    </span><span class='hljl-n'>f</span><span class='hljl-p'>,</span><span class='hljl-t'>
    </span><span class='hljl-n'>kb07</span><span class='hljl-p'>,</span><span class='hljl-t'>
    </span><span class='hljl-n'>contrasts</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Dict</span><span class='hljl-p'>(</span><span class='hljl-sc'>:spkr</span><span class='hljl-t'> </span><span class='hljl-oB'>=&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>HelmertCoding</span><span class='hljl-p'>(</span><span class='hljl-n'>levels</span><span class='hljl-oB'>=</span><span class='hljl-nf'>reverse</span><span class='hljl-p'>(</span><span class='hljl-n'>spkr_levels</span><span class='hljl-p'>))))</span>
</pre>


<pre class="output">
Linear mixed model fit by maximum likelihood
 rt_trunc ~ 1 &#43; spkr &#43; prec &#43; spkr &amp; prec &#43; &#40;1 | subj&#41;
     logLik        -2 logLik          AIC             BIC       
 -1.45767208×10⁴  2.91534417×10⁴  2.91654417×10⁴  2.91983781×10⁴

Variance components:
            Column    Variance  Std.Dev. 
subj     &#40;Intercept&#41;   95885.39 309.65366
Residual              662657.47 814.03776
 Number of obs: 1789; levels of grouping factors: 56

  Fixed-effects parameters:
──────────────────────────────────────────────────────────────────
                             Estimate  Std.Error  z value  P&#40;&gt;|z|&#41;
──────────────────────────────────────────────────────────────────
&#40;Intercept&#41;                 2515.31      49.5243    50.79   &lt;1e-99
spkr: old                     89.9962    27.2107     3.31   0.0009
prec: maintain              -666.735     38.4928   -17.32   &lt;1e-66
spkr: old &amp; prec: maintain   -43.3882    38.4928    -1.13   0.2597
──────────────────────────────────────────────────────────────────
</pre>


<h2>Built in contrast coding schemes</h2>
<p>StatsModels.jl provides a few commonly used contrast coding schemes, some less-commonly used schemes, and structs that allow you to manually specify your own, custom schemes.</p>
<p>All are subtypes of the <code>AbstractContrasts</code> type:</p>


<pre class='hljl'>
<span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>InteractiveUtils</span><span class='hljl-t'>
</span><span class='hljl-nf'>subtypes</span><span class='hljl-p'>(</span><span class='hljl-n'>AbstractContrasts</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
7-element Array&#123;Any,1&#125;:
 StatsModels.ContrastsCoding 
 StatsModels.DummyCoding     
 StatsModels.EffectsCoding   
 StatsModels.FullDummyCoding 
 StatsModels.HelmertCoding   
 StatsModels.HypothesisCoding
 StatsModels.SeqDiffCoding
</pre>


<p>And all have fairly extensive documentation via the normal help system. For instance:</p>


<pre class='hljl'>
<span class='hljl-cs'># use ?SeqDiffCoding in the REPL</span>
</pre>



<h3>Standard contrasts</h3>
<p>The most commonly used contrasts are <code>DummyCoding</code> and <code>EffectsCoding</code> &#40;which are similar to <code>contr.treatment</code> and <code>contr.sum</code> in R, respectively&#41;.</p>
<h3>&quot;Exotic&quot; contrasts</h3>
<p>We also provide <code>HelmertCoding</code> and <code>SeqDiffCoding</code> &#40;corresponding to base R&#39;s <code>contr.helmert</code> and MASS&#39;s <code>contr.sdiff</code>&#41;.</p>
<h2>Manual contrasts</h2>
<p>There are two ways to manually specify contrasts. First, you can specify them <strong>directly</strong> via <code>ContrastsCoding</code>. If you do, it&#39;s good practice to specify the levels corresponding to the rows of the matrix, although they can be omitted in which case they&#39;ll be inferred from the data.</p>
<p>For instance, here&#39;s a weird set of contrasts for <code>:spkr</code>:</p>


<pre class='hljl'>
<span class='hljl-n'>cs</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Matrix</span><span class='hljl-p'>([</span><span class='hljl-oB'>-</span><span class='hljl-ni'>1</span><span class='hljl-oB'>/</span><span class='hljl-ni'>3</span><span class='hljl-t'> </span><span class='hljl-ni'>2</span><span class='hljl-oB'>/</span><span class='hljl-ni'>3</span><span class='hljl-p'>]</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>contr_manual</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Dict</span><span class='hljl-p'>(</span><span class='hljl-sc'>:spkr</span><span class='hljl-t'> </span><span class='hljl-oB'>=&gt;</span><span class='hljl-t'> </span><span class='hljl-n'>StatsModels</span><span class='hljl-oB'>.</span><span class='hljl-nf'>ContrastsCoding</span><span class='hljl-p'>(</span><span class='hljl-n'>cs</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>levels</span><span class='hljl-oB'>=</span><span class='hljl-p'>[</span><span class='hljl-s'>&quot;old&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;new&quot;</span><span class='hljl-p'>]))</span><span class='hljl-t'>
</span><span class='hljl-n'>mod3</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>fit</span><span class='hljl-p'>(</span><span class='hljl-n'>MixedModel</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>f</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>kb07</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>contrasts</span><span class='hljl-oB'>=</span><span class='hljl-n'>contr_manual</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
Linear mixed model fit by maximum likelihood
 rt_trunc ~ 1 &#43; spkr &#43; prec &#43; spkr &amp; prec &#43; &#40;1 | subj&#41;
     logLik        -2 logLik          AIC             BIC       
 -1.45767208×10⁴  2.91534417×10⁴  2.91654417×10⁴  2.91983781×10⁴

Variance components:
            Column    Variance  Std.Dev. 
subj     &#40;Intercept&#41;   95885.39 309.65366
Residual              662657.47 814.03776
 Number of obs: 1789; levels of grouping factors: 56

  Fixed-effects parameters:
──────────────────────────────────────────────────────────────────
                             Estimate  Std.Error  z value  P&#40;&gt;|z|&#41;
──────────────────────────────────────────────────────────────────
&#40;Intercept&#41;                 2545.31      50.3425    50.56   &lt;1e-99
spkr: new                   -179.992     54.4214    -3.31   0.0009
prec: maintain              -681.198     40.582    -16.79   &lt;1e-62
spkr: new &amp; prec: maintain    86.7763    76.9856     1.13   0.2597
──────────────────────────────────────────────────────────────────
</pre>


<p>&#40;Note that the estimates and even the signs of the fixed effect βs change when we change the contrasts, but the overall log-likelihood doesn&#39;t&#41;.</p>
<p>We can see that the values from the contrasts matrix we specified are plugged directly in to the fixed effects matrix, and are also used in computing the predictor for the interaction:</p>


<pre class='hljl'>
<span class='hljl-n'>mod3</span><span class='hljl-oB'>.</span><span class='hljl-n'>X</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-oB'>:</span><span class='hljl-ni'>5</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-oB'>:</span><span class='hljl-p'>]</span>
</pre>


<pre class="output">
5×4 Array&#123;Float64,2&#125;:
 1.0   0.666667  0.0   0.0     
 1.0  -0.333333  1.0  -0.333333
 1.0  -0.333333  0.0  -0.0     
 1.0   0.666667  1.0   0.666667
 1.0   0.666667  0.0   0.0
</pre>


<h3>Example: manual Helmert contrasts</h3>
<p>Let&#39;s say you want Helmert contrasts but you always forget what it&#39;s called. Here&#39;s how you can manually specify them using <code>StatsModels.ContrastsCoding</code>.</p>
<p>Because this isn&#39;t very interesting with only two levels, let&#39;s combine <code>:spkr</code> and <code>:prec</code> into a single, 4-level variable:</p>


<pre class='hljl'>
<span class='hljl-n'>kb07ex</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nd'>@transform</span><span class='hljl-p'>(</span><span class='hljl-n'>kb07</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>spkr_prec</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-sc'>:spkr</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;-&quot;</span><span class='hljl-t'> </span><span class='hljl-oB'>.*</span><span class='hljl-t'> </span><span class='hljl-sc'>:prec</span><span class='hljl-p'>);</span><span class='hljl-t'>
</span><span class='hljl-n'>levels</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-s'>&quot;new-break&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;new-maintain&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;old-break&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;old-maintain&quot;</span><span class='hljl-p'>]</span><span class='hljl-t'>
</span><span class='hljl-n'>f2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nd'>@formula</span><span class='hljl-p'>(</span><span class='hljl-n'>rt_trunc</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>spkr_prec</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>|</span><span class='hljl-t'> </span><span class='hljl-n'>subj</span><span class='hljl-p'>))</span>
</pre>


<pre class="output">
FormulaTerm
Response:
  rt_trunc&#40;unknown&#41;
Predictors:
  1
  spkr_prec&#40;unknown&#41;
  &#40;subj&#41;-&gt;1 | subj
</pre>



<pre class='hljl'>
<span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>StatsModels</span><span class='hljl-oB'>:</span><span class='hljl-t'> </span><span class='hljl-n'>ContrastsCoding</span><span class='hljl-t'>
</span><span class='hljl-n'>man_helm</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-oB'>-</span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-ni'>1</span><span class='hljl-t'>
             </span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-ni'>1</span><span class='hljl-t'>
             </span><span class='hljl-ni'>0</span><span class='hljl-t'>  </span><span class='hljl-ni'>2</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-ni'>1</span><span class='hljl-t'>
             </span><span class='hljl-ni'>0</span><span class='hljl-t'>  </span><span class='hljl-ni'>0</span><span class='hljl-t'>  </span><span class='hljl-ni'>3</span><span class='hljl-p'>]</span><span class='hljl-t'>
</span><span class='hljl-n'>contr_helm_man</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>ContrastsCoding</span><span class='hljl-p'>(</span><span class='hljl-n'>man_helm</span><span class='hljl-p'>[</span><span class='hljl-oB'>:</span><span class='hljl-p'>,</span><span class='hljl-ni'>1</span><span class='hljl-oB'>:</span><span class='hljl-ni'>3</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>levels</span><span class='hljl-oB'>=</span><span class='hljl-n'>levels</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>fit</span><span class='hljl-p'>(</span><span class='hljl-n'>MixedModel</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>f2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>kb07ex</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>contrasts</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Dict</span><span class='hljl-p'>(</span><span class='hljl-sc'>:spkr_prec</span><span class='hljl-t'> </span><span class='hljl-oB'>=&gt;</span><span class='hljl-t'> </span><span class='hljl-n'>contr_helm_man</span><span class='hljl-p'>))</span>
</pre>


<pre class="output">
Linear mixed model fit by maximum likelihood
 rt_trunc ~ 1 &#43; spkr_prec &#43; &#40;1 | subj&#41;
     logLik        -2 logLik          AIC             BIC       
 -1.45767208×10⁴  2.91534417×10⁴  2.91654417×10⁴  2.91983781×10⁴

Variance components:
            Column    Variance  Std.Dev. 
subj     &#40;Intercept&#41;   95885.39 309.65366
Residual              662657.47 814.03776
 Number of obs: 1789; levels of grouping factors: 56

  Fixed-effects parameters:
───────────────────────────────────────────────────────────────
                          Estimate  Std.Error  z value  P&#40;&gt;|z|&#41;
───────────────────────────────────────────────────────────────
&#40;Intercept&#41;              2181.94      45.6362    47.81   &lt;1e-99
spkr_prec: new-maintain  -311.673     27.2107   -11.45   &lt;1e-29
spkr_prec: old-break      163.889     15.7041    10.44   &lt;1e-24
spkr_prec: old-maintain   -95.5865    11.1225    -8.59   &lt;1e-17
───────────────────────────────────────────────────────────────
</pre>


<p>We can see that this is equivalent to <code>HelmertCoding</code>:</p>


<pre class='hljl'>
<span class='hljl-nf'>fit</span><span class='hljl-p'>(</span><span class='hljl-n'>MixedModel</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>f2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>kb07ex</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>contrasts</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Dict</span><span class='hljl-p'>(</span><span class='hljl-sc'>:spkr_prec</span><span class='hljl-t'> </span><span class='hljl-oB'>=&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>HelmertCoding</span><span class='hljl-p'>(</span><span class='hljl-n'>levels</span><span class='hljl-oB'>=</span><span class='hljl-n'>levels</span><span class='hljl-p'>)))</span>
</pre>


<pre class="output">
Linear mixed model fit by maximum likelihood
 rt_trunc ~ 1 &#43; spkr_prec &#43; &#40;1 | subj&#41;
     logLik        -2 logLik          AIC             BIC       
 -1.45767208×10⁴  2.91534417×10⁴  2.91654417×10⁴  2.91983781×10⁴

Variance components:
            Column    Variance  Std.Dev. 
subj     &#40;Intercept&#41;   95885.39 309.65366
Residual              662657.47 814.03776
 Number of obs: 1789; levels of grouping factors: 56

  Fixed-effects parameters:
───────────────────────────────────────────────────────────────
                          Estimate  Std.Error  z value  P&#40;&gt;|z|&#41;
───────────────────────────────────────────────────────────────
&#40;Intercept&#41;              2181.94      45.6362    47.81   &lt;1e-99
spkr_prec: new-maintain  -311.673     27.2107   -11.45   &lt;1e-29
spkr_prec: old-break      163.889     15.7041    10.44   &lt;1e-24
spkr_prec: old-maintain   -95.5865    11.1225    -8.59   &lt;1e-17
───────────────────────────────────────────────────────────────
</pre>


<h2>Contrasts from hypotheses</h2>
<p>A better way to specify manual contrasts is via <code>HypothesisCoding</code>, where each row of the matrix corresponds to the weights given to the cell means of the levels corresponding to each column &#40;see <a href="https://doi.org/10.1016/j.jml.2019.104038">Schad et al. 2020</a> for more information&#41;. This is less interesting with only two levels, so let&#39;s look at a scenario where we combine <code>:spkr</code> and <code>:prec</code> into a single, 4-level predictor, and want to test some strange hypotheses.</p>


<pre class='hljl'>
<span class='hljl-n'>f2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nd'>@formula</span><span class='hljl-p'>(</span><span class='hljl-n'>rt_trunc</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>spkr_prec</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>|</span><span class='hljl-t'> </span><span class='hljl-n'>subj</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-n'>mod4</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>fit</span><span class='hljl-p'>(</span><span class='hljl-n'>MixedModel</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>f2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>kb07ex</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
Linear mixed model fit by maximum likelihood
 rt_trunc ~ 1 &#43; spkr_prec &#43; &#40;1 | subj&#41;
     logLik        -2 logLik          AIC             BIC       
 -1.45767208×10⁴  2.91534417×10⁴  2.91654417×10⁴  2.91983781×10⁴

Variance components:
            Column    Variance  Std.Dev. 
subj     &#40;Intercept&#41;   95885.39 309.65366
Residual              662657.47 814.03776
 Number of obs: 1789; levels of grouping factors: 56

  Fixed-effects parameters:
──────────────────────────────────────────────────────────────
                         Estimate  Std.Error  z value  P&#40;&gt;|z|&#41;
──────────────────────────────────────────────────────────────
&#40;Intercept&#41;              2425.32     56.5224    42.91   &lt;1e-99
spkr_prec: new-maintain  -623.347    54.4214   -11.45   &lt;1e-29
spkr_prec: old-break      179.992    54.4214     3.31   0.0009
spkr_prec: old-maintain  -530.131    54.4839    -9.73   &lt;1e-21
──────────────────────────────────────────────────────────────
</pre>


<p>Let&#39;s say we want to test whether the effect of <code>:prec</code> depends on whether <code>:spkr</code> is old vs. new. We need one contrast to test the hypothesis that <code>&quot;maintain&quot; &#33;&#61; &quot;break&quot;</code> for &quot;new&quot;, and another for &quot;old&quot;. That leaves one over, to test the overall difference between &quot;new&quot; and &quot;old&quot;.</p>


<pre class='hljl'>
<span class='hljl-n'>prec_old</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>levels</span><span class='hljl-t'> </span><span class='hljl-oB'>.==</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;old-break&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>.-</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>levels</span><span class='hljl-t'> </span><span class='hljl-oB'>.==</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;old-maintain&quot;</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
4-element Array&#123;Int64,1&#125;:
  0
  0
  1
 -1
</pre>



<pre class='hljl'>
<span class='hljl-n'>prec_new</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>levels</span><span class='hljl-t'> </span><span class='hljl-oB'>.==</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;new-break&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>.-</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>levels</span><span class='hljl-t'> </span><span class='hljl-oB'>.==</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;new-maintain&quot;</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
4-element Array&#123;Int64,1&#125;:
  1
 -1
  0
  0
</pre>



<pre class='hljl'>
<span class='hljl-n'>old_new</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>abs</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-n'>prec_old</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>.-</span><span class='hljl-t'> </span><span class='hljl-n'>abs</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-n'>prec_new</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-oB'>./</span><span class='hljl-t'> </span><span class='hljl-ni'>2</span>
</pre>


<pre class="output">
4-element Array&#123;Float64,1&#125;:
 -0.5
 -0.5
  0.5
  0.5
</pre>



<pre class='hljl'>
<span class='hljl-n'>contr_hyp</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>HypothesisCoding</span><span class='hljl-p'>(</span><span class='hljl-nf'>Matrix</span><span class='hljl-p'>(</span><span class='hljl-nf'>hcat</span><span class='hljl-p'>(</span><span class='hljl-n'>old_new</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>prec_old</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>prec_new</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>),</span><span class='hljl-t'>
                             </span><span class='hljl-n'>labels</span><span class='hljl-oB'>=</span><span class='hljl-p'>[</span><span class='hljl-s'>&quot;old&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;(old) break&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;(new) break&quot;</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-n'>contr_hyp</span><span class='hljl-oB'>.</span><span class='hljl-n'>hypotheses</span>
</pre>


<pre class="output">
3×4 Array&#123;Float64,2&#125;:
 -0.5  -0.5  0.5   0.5
  0.0   0.0  1.0  -1.0
  1.0  -1.0  0.0   0.0
</pre>


<p>These hypotheses correspond to the following <em>contrasts</em> &#40;using the <a href="https://docs.julialang.org/en/v1/base/math/#Base.rationalize"><code>rationalize</code></a> function to make pretty fractions, like the <code>fractions</code> function in R&#41;:</p>


<pre class='hljl'>
<span class='hljl-n'>rationalize</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-n'>contr_hyp</span><span class='hljl-oB'>.</span><span class='hljl-n'>contrasts</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>tol</span><span class='hljl-oB'>=</span><span class='hljl-nfB'>1e-10</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
4×3 Array&#123;Rational&#123;Int64&#125;,2&#125;:
 -1//2   0//1   1//2
 -1//2   0//1  -1//2
  1//2   1//2   0//1
  1//2  -1//2   0//1
</pre>


<p>Notice how the ±1 coding in the hypotheses &#40;which translates into the difference between the mean response in those cells&#41; is transformed into ±½ coding in the contrasts.</p>


<pre class='hljl'>
<span class='hljl-n'>mod5</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>fit</span><span class='hljl-p'>(</span><span class='hljl-n'>MixedModel</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>f2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>kb07ex</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>contrasts</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Dict</span><span class='hljl-p'>(</span><span class='hljl-sc'>:spkr_prec</span><span class='hljl-t'> </span><span class='hljl-oB'>=&gt;</span><span class='hljl-t'> </span><span class='hljl-n'>contr_hyp</span><span class='hljl-p'>))</span>
</pre>


<pre class="output">
Linear mixed model fit by maximum likelihood
 rt_trunc ~ 1 &#43; spkr_prec &#43; &#40;1 | subj&#41;
     logLik        -2 logLik          AIC             BIC       
 -1.45767208×10⁴  2.91534417×10⁴  2.91654417×10⁴  2.91983781×10⁴

Variance components:
            Column    Variance  Std.Dev. 
subj     &#40;Intercept&#41;   95885.39 309.65366
Residual              662657.47 814.03776
 Number of obs: 1789; levels of grouping factors: 56

  Fixed-effects parameters:
─────────────────────────────────────────────────────────────
                        Estimate  Std.Error  z value  P&#40;&gt;|z|&#41;
─────────────────────────────────────────────────────────────
&#40;Intercept&#41;             2181.94     45.6362    47.81   &lt;1e-99
spkr_prec: old           136.604    38.4928     3.55   0.0004
spkr_prec: &#40;old&#41; break   710.123    54.4527    13.04   &lt;1e-38
spkr_prec: &#40;new&#41; break   623.347    54.4214    11.45   &lt;1e-29
─────────────────────────────────────────────────────────────
</pre>


<p>Note that this is equivalent to the <code>/</code> &quot;nesting&quot; syntax using <code>EffectsCoding</code>, after adjusting for the 2× factor from the &#43;1/-1 coding:</p>


<pre class='hljl'>
<span class='hljl-n'>mod6</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>fit</span><span class='hljl-p'>(</span><span class='hljl-n'>MixedModel</span><span class='hljl-p'>,</span><span class='hljl-t'>
           </span><span class='hljl-nd'>@formula</span><span class='hljl-p'>(</span><span class='hljl-n'>rt_trunc</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>spkr</span><span class='hljl-oB'>/</span><span class='hljl-n'>prec</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-oB'>|</span><span class='hljl-n'>subj</span><span class='hljl-p'>)),</span><span class='hljl-t'> 
           </span><span class='hljl-n'>kb07</span><span class='hljl-p'>,</span><span class='hljl-t'>
           </span><span class='hljl-n'>contrasts</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Dict</span><span class='hljl-p'>(</span><span class='hljl-sc'>:spkr</span><span class='hljl-t'> </span><span class='hljl-oB'>=&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>EffectsCoding</span><span class='hljl-p'>(</span><span class='hljl-n'>base</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;new&quot;</span><span class='hljl-p'>),</span><span class='hljl-t'>
                            </span><span class='hljl-sc'>:prec</span><span class='hljl-t'> </span><span class='hljl-oB'>=&gt;</span><span class='hljl-t'> </span><span class='hljl-nf'>EffectsCoding</span><span class='hljl-p'>(</span><span class='hljl-n'>base</span><span class='hljl-oB'>=</span><span class='hljl-s'>&quot;maintain&quot;</span><span class='hljl-p'>)))</span>
</pre>


<pre class="output">
Linear mixed model fit by maximum likelihood
 rt_trunc ~ 1 &#43; spkr &#43; spkr &amp; prec &#43; &#40;1 | subj&#41;
     logLik        -2 logLik          AIC             BIC       
 -1.45767208×10⁴  2.91534417×10⁴  2.91654417×10⁴  2.91983781×10⁴

Variance components:
            Column    Variance  Std.Dev. 
subj     &#40;Intercept&#41;   95885.39 309.65366
Residual              662657.47 814.03776
 Number of obs: 1789; levels of grouping factors: 56

  Fixed-effects parameters:
───────────────────────────────────────────────────────────────
                          Estimate  Std.Error  z value  P&#40;&gt;|z|&#41;
───────────────────────────────────────────────────────────────
&#40;Intercept&#41;              2181.94      45.6362    47.81   &lt;1e-99
spkr: old                  68.3021    19.2464     3.55   0.0004
spkr: new &amp; prec: break   311.673     27.2107    11.45   &lt;1e-29
spkr: old &amp; prec: break   355.062     27.2263    13.04   &lt;1e-38
───────────────────────────────────────────────────────────────
</pre>


<h3>Example: Helmert contrasts that actually make sense</h3>
<p>Let&#39;s say you want something like Helmert contrasts, but where the βs are interpretable as the difference between the <span class="math">$n$</span>th level and the average of levels <span class="math">$1\ldots n-1$</span>.  Here are the hypotheses that correspond to that:</p>


<pre class='hljl'>
<span class='hljl-n'>helmert_hypotheses</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-oB'>-</span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-ni'>1</span><span class='hljl-oB'>/</span><span class='hljl-ni'>2</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-ni'>1</span><span class='hljl-oB'>/</span><span class='hljl-ni'>3</span><span class='hljl-t'>
                       </span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-ni'>1</span><span class='hljl-oB'>/</span><span class='hljl-ni'>2</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-ni'>1</span><span class='hljl-oB'>/</span><span class='hljl-ni'>3</span><span class='hljl-t'>
                       </span><span class='hljl-ni'>0</span><span class='hljl-t'>  </span><span class='hljl-ni'>1</span><span class='hljl-t'>   </span><span class='hljl-oB'>-</span><span class='hljl-ni'>1</span><span class='hljl-oB'>/</span><span class='hljl-ni'>3</span><span class='hljl-t'>
                      </span><span class='hljl-ni'>0</span><span class='hljl-t'>  </span><span class='hljl-ni'>0</span><span class='hljl-t'>    </span><span class='hljl-ni'>1</span><span class='hljl-p'>]</span>
</pre>


<pre class="output">
4×3 Array&#123;Float64,2&#125;:
 -1.0  -0.5  -0.333333
  1.0  -0.5  -0.333333
  0.0   1.0  -0.333333
  0.0   0.0   1.0
</pre>


<p>And the resulting contrasts matrix:</p>


<pre class='hljl'>
<span class='hljl-n'>contr_helm_hyp</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>HypothesisCoding</span><span class='hljl-p'>(</span><span class='hljl-nf'>Matrix</span><span class='hljl-p'>(</span><span class='hljl-n'>helmert_hypotheses</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>levels</span><span class='hljl-oB'>=</span><span class='hljl-n'>levels</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>contr_helm_hyp</span><span class='hljl-oB'>.</span><span class='hljl-n'>contrasts</span>
</pre>


<pre class="output">
4×3 Array&#123;Float64,2&#125;:
 -0.5          -0.333333     -0.25
  0.5          -0.333333     -0.25
  5.88785e-17   0.666667     -0.25
  5.88785e-17   2.97183e-16   0.75
</pre>


<p>Which is similar but not identical to the contrats matrix for HelmertCoding&#33;  In a way that I would not be able to derive off the top of my head.</p>
<p>Now we fit the model:</p>


<pre class='hljl'>
<span class='hljl-nf'>fit</span><span class='hljl-p'>(</span><span class='hljl-n'>MixedModel</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>f2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>kb07ex</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>contrasts</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Dict</span><span class='hljl-p'>(</span><span class='hljl-sc'>:spkr_prec</span><span class='hljl-t'> </span><span class='hljl-oB'>=&gt;</span><span class='hljl-t'> </span><span class='hljl-n'>contr_helm_hyp</span><span class='hljl-p'>))</span>
</pre>


<pre class="output">
Linear mixed model fit by maximum likelihood
 rt_trunc ~ 1 &#43; spkr_prec &#43; &#40;1 | subj&#41;
     logLik        -2 logLik          AIC             BIC       
 -1.45767208×10⁴  2.91534417×10⁴  2.91654417×10⁴  2.91983781×10⁴

Variance components:
            Column    Variance  Std.Dev. 
subj     &#40;Intercept&#41;   95885.39 309.65366
Residual              662657.47 814.03776
 Number of obs: 1789; levels of grouping factors: 56

  Fixed-effects parameters:
──────────────────────────────────────────────────────────────
                         Estimate  Std.Error  z value  P&#40;&gt;|z|&#41;
──────────────────────────────────────────────────────────────
&#40;Intercept&#41;              2181.94     45.6362    47.81   &lt;1e-99
spkr_prec: new-maintain  -623.347    54.4214   -11.45   &lt;1e-29
spkr_prec: old-break      491.666    47.1123    10.44   &lt;1e-24
spkr_prec: old-maintain  -382.346    44.4902    -8.59   &lt;1e-17
──────────────────────────────────────────────────────────────
</pre>


<p>...and we can see that the βs for levels are very close to the cumulative means minus the mean for that level, computed manually</p>


<pre class='hljl'>
<span class='hljl-cs'># (using join to make sure the levels are in the right order)</span><span class='hljl-t'>
</span><span class='hljl-n'>lev_means</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>join</span><span class='hljl-p'>(</span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-n'>spkr_prec</span><span class='hljl-oB'>=</span><span class='hljl-n'>levels</span><span class='hljl-p'>),</span><span class='hljl-t'>
                 </span><span class='hljl-nf'>by</span><span class='hljl-p'>(</span><span class='hljl-n'>kb07ex</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:spkr_prec</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>mean_rt</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-sc'>:rt_trunc</span><span class='hljl-t'> </span><span class='hljl-oB'>=&gt;</span><span class='hljl-t'> </span><span class='hljl-n'>mean</span><span class='hljl-p'>),</span><span class='hljl-t'>
                 </span><span class='hljl-n'>on</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-sc'>:spkr_prec</span><span class='hljl-p'>)</span><span class='hljl-t'>

</span><span class='hljl-n'>lev_means</span><span class='hljl-p'>[</span><span class='hljl-oB'>!</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:cum_mean</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>.=</span><span class='hljl-t'> </span><span class='hljl-nf'>cumsum</span><span class='hljl-p'>(</span><span class='hljl-n'>lev_means</span><span class='hljl-oB'>.</span><span class='hljl-n'>mean_rt</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>./</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-oB'>:</span><span class='hljl-ni'>4</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>lev_means</span><span class='hljl-p'>[</span><span class='hljl-oB'>!</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:diff_with_last_mean</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>.=</span><span class='hljl-t'> </span><span class='hljl-n'>lev_means</span><span class='hljl-oB'>.</span><span class='hljl-n'>mean_rt</span><span class='hljl-t'> </span><span class='hljl-oB'>.-</span><span class='hljl-t'> </span><span class='hljl-nf'>lag</span><span class='hljl-p'>(</span><span class='hljl-n'>lev_means</span><span class='hljl-oB'>.</span><span class='hljl-n'>cum_mean</span><span class='hljl-p'>)</span><span class='hljl-t'>

</span><span class='hljl-n'>lev_means</span>
</pre>



<table class="data-frame"><thead><tr><th></th><th>spkr_prec</th><th>mean_rt</th><th>cum_mean</th><th>diff_with_last_mean</th></tr><tr><th></th><th>String</th><th>Float64</th><th>Float64</th><th>Float64⍰</th></tr></thead><tbody><p>4 rows × 4 columns</p><tr><th>1</th><td>new-break</td><td>2425.43</td><td>2425.43</td><td>missing</td></tr><tr><th>2</th><td>new-maintain</td><td>1801.97</td><td>2113.7</td><td>-623.465</td></tr><tr><th>3</th><td>old-break</td><td>2605.31</td><td>2277.57</td><td>491.607</td></tr><tr><th>4</th><td>old-maintain</td><td>1895.35</td><td>2182.02</td><td>-382.218</td></tr></tbody></table>

<h1>The <code>@formula</code></h1>
<p>A formula in Julia is created with the <code>@formula</code> macro.  Between the macro and fitting a model, the formula goes through a number of steps.</p>
<ul>
<li><p>The <code>@formula</code> macro itself does some transformations on the syntax, and creates <code>Term</code>s</p>
</li>
<li><p>Then a <code>Schema</code> is extracted from the data, which says which <code>Term</code>s are <code>ContinuousTerm</code>s and which are <code>CategoricalTerm</code>s</p>
</li>
<li><p>The <code>Schema</code> is then used to transform the original formula into a &quot;concrete formula&quot;.</p>
</li>
<li><p>The concrete formula &#40;with all <code>Term</code>s replaced by continuous/categorical versions&#41; generates model matrix columns when given some data.</p>
</li>
</ul>
<p>The details are described in the <a href="https://juliastats.org/StatsModels.jl/stable/internals/#The-lifecycle-of-a-@formula-1">documentation</a>, and for the most part modeling packages handle these steps for you.  But in the interest of allowing you to do your own weird things, here are a few examples.</p>
<h2>A formula is made of terms</h2>


<pre class='hljl'>
<span class='hljl-n'>f</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nd'>@formula</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>a</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>b</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>a</span><span class='hljl-oB'>&amp;</span><span class='hljl-n'>b</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
FormulaTerm
Response:
  y&#40;unknown&#41;
Predictors:
  1
  a&#40;unknown&#41;
  b&#40;unknown&#41;
  a&#40;unknown&#41; &amp; b&#40;unknown&#41;
</pre>


<p>You can inpsect the internal structure with &#40;it&#39;s like <code>str</code> in R&#41;:</p>


<pre class='hljl'>
<span class='hljl-nf'>dump</span><span class='hljl-p'>(</span><span class='hljl-n'>f</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
StatsModels.FormulaTerm&#123;StatsModels.Term,Tuple&#123;StatsModels.ConstantTerm&#123;Int
64&#125;,StatsModels.Term,StatsModels.Term,StatsModels.InteractionTerm&#123;Tuple&#123;Sta
tsModels.Term,StatsModels.Term&#125;&#125;&#125;&#125;
  lhs: StatsModels.Term
    sym: Symbol y
  rhs: Tuple&#123;StatsModels.ConstantTerm&#123;Int64&#125;,StatsModels.Term,StatsModels.T
erm,StatsModels.InteractionTerm&#123;Tuple&#123;StatsModels.Term,StatsModels.Term&#125;&#125;&#125;
    1: StatsModels.ConstantTerm&#123;Int64&#125;
      n: Int64 1
    2: StatsModels.Term
      sym: Symbol a
    3: StatsModels.Term
      sym: Symbol b
    4: StatsModels.InteractionTerm&#123;Tuple&#123;StatsModels.Term,StatsModels.Term&#125;
&#125;
      terms: Tuple&#123;StatsModels.Term,StatsModels.Term&#125;
        1: StatsModels.Term
          sym: Symbol a
        2: StatsModels.Term
          sym: Symbol b
</pre>


<p>We can build the same formula directly, using terms:</p>


<pre class='hljl'>
<span class='hljl-n'>t_a</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>term</span><span class='hljl-p'>(</span><span class='hljl-sc'>:a</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>t_b</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>term</span><span class='hljl-p'>(</span><span class='hljl-sc'>:b</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>t_1</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>term</span><span class='hljl-p'>(</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-n'>t_y</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>term</span><span class='hljl-p'>(</span><span class='hljl-sc'>:y</span><span class='hljl-p'>)</span><span class='hljl-t'>

</span><span class='hljl-nf'>dump</span><span class='hljl-p'>(</span><span class='hljl-n'>t_a</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
StatsModels.Term
  sym: Symbol a
</pre>



<pre class='hljl'>
<span class='hljl-n'>f_dir</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>FormulaTerm</span><span class='hljl-p'>(</span><span class='hljl-n'>t_y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>t_1</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>t_a</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>t_b</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>InteractionTerm</span><span class='hljl-p'>((</span><span class='hljl-n'>t_a</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>t_b</span><span class='hljl-p'>))))</span>
</pre>


<pre class="output">
FormulaTerm
Response:
  y&#40;unknown&#41;
Predictors:
  1
  a&#40;unknown&#41;
  b&#40;unknown&#41;
  a&#40;unknown&#41; &amp; b&#40;unknown&#41;
</pre>


<p>Or, using operator overloading:</p>


<pre class='hljl'>
<span class='hljl-n'>f_op</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>t_y</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-n'>t_1</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>t_a</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>t_b</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>t_a</span><span class='hljl-t'> </span><span class='hljl-oB'>&amp;</span><span class='hljl-t'> </span><span class='hljl-n'>t_b</span>
</pre>


<pre class="output">
FormulaTerm
Response:
  y&#40;unknown&#41;
Predictors:
  1
  a&#40;unknown&#41;
  b&#40;unknown&#41;
  a&#40;unknown&#41; &amp; b&#40;unknown&#41;
</pre>


<p>These three are all equivalent:</p>


<pre class='hljl'>
<span class='hljl-n'>f</span><span class='hljl-t'> </span><span class='hljl-oB'>==</span><span class='hljl-t'> </span><span class='hljl-n'>f_dir</span><span class='hljl-t'> </span><span class='hljl-oB'>==</span><span class='hljl-t'> </span><span class='hljl-n'>f_op</span>
</pre>


<pre class="output">
true
</pre>


<h2>The schema gives concrete terms</h2>
<p>If we have some fake data:</p>


<pre class='hljl'>
<span class='hljl-n'>df</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>rand</span><span class='hljl-p'>(</span><span class='hljl-ni'>100</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>a</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>rand</span><span class='hljl-p'>(</span><span class='hljl-ni'>100</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>b</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>repeat</span><span class='hljl-p'>([</span><span class='hljl-sc'>:Q</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:R</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:S</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:T</span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-ni'>25</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-nf'>first</span><span class='hljl-p'>(</span><span class='hljl-n'>df</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>5</span><span class='hljl-p'>)</span>
</pre>



<table class="data-frame"><thead><tr><th></th><th>y</th><th>a</th><th>b</th></tr><tr><th></th><th>Float64</th><th>Float64</th><th>Symbol</th></tr></thead><tbody><p>5 rows × 3 columns</p><tr><th>1</th><td>0.540907</td><td>0.781543</td><td>Q</td></tr><tr><th>2</th><td>0.820203</td><td>0.0525262</td><td>R</td></tr><tr><th>3</th><td>0.916497</td><td>0.0619198</td><td>S</td></tr><tr><th>4</th><td>0.227406</td><td>0.308941</td><td>T</td></tr><tr><th>5</th><td>0.197333</td><td>0.0778339</td><td>Q</td></tr></tbody></table>

<p>We can extract a <code>Schema</code>:</p>


<pre class='hljl'>
<span class='hljl-n'>sch</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>schema</span><span class='hljl-p'>(</span><span class='hljl-n'>df</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
StatsModels.Schema with 3 entries:
  a &#61;&gt; a
  y &#61;&gt; y
  b &#61;&gt; b
</pre>


<p>This maps un-typed <code>Term</code>s to concrete verisons.  Now we know that <code>:a</code> is a continuous variable in this dataset:</p>


<pre class='hljl'>
<span class='hljl-n'>sch</span><span class='hljl-p'>[</span><span class='hljl-nf'>term</span><span class='hljl-p'>(</span><span class='hljl-sc'>:a</span><span class='hljl-p'>)]</span>
</pre>


<pre class="output">
a&#40;continuous&#41;
</pre>


<p>Categorical terms hold the contrasts matrix and levels:</p>


<pre class='hljl'>
<span class='hljl-n'>t_b_concrete</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>sch</span><span class='hljl-p'>[</span><span class='hljl-nf'>term</span><span class='hljl-p'>(</span><span class='hljl-sc'>:b</span><span class='hljl-p'>)]</span>
</pre>


<pre class="output">
b&#40;StatsModels.DummyCoding:4→3&#41;
</pre>



<pre class='hljl'>
<span class='hljl-n'>cmat</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>t_b_concrete</span><span class='hljl-oB'>.</span><span class='hljl-n'>contrasts</span><span class='hljl-t'>
</span><span class='hljl-n'>cmat</span><span class='hljl-oB'>.</span><span class='hljl-n'>matrix</span>
</pre>


<pre class="output">
4×3 Array&#123;Float64,2&#125;:
 0.0  0.0  0.0
 1.0  0.0  0.0
 0.0  1.0  0.0
 0.0  0.0  1.0
</pre>



<pre class='hljl'>
<span class='hljl-n'>cmat</span><span class='hljl-oB'>.</span><span class='hljl-n'>levels</span>
</pre>


<pre class="output">
4-element Array&#123;Symbol,1&#125;:
 :Q
 :R
 :S
 :T
</pre>


<h2><code>apply_schema</code> combines terms and schema to get concrete versions</h2>
<p>The canonical case is to apply the schema to the whole formula:</p>


<pre class='hljl'>
<span class='hljl-nf'>apply_schema</span><span class='hljl-p'>(</span><span class='hljl-n'>f</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>sch</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
FormulaTerm
Response:
  y&#40;continuous&#41;
Predictors:
  1
  a&#40;continuous&#41;
  b&#40;StatsModels.DummyCoding:4→3&#41;
  a&#40;continuous&#41; &amp; b&#40;StatsModels.DummyCoding:4→3&#41;
</pre>


<p>Note that the schema gets pushed through the interaction term, too.</p>
<p>We can also apply the schema to a single term:</p>


<pre class='hljl'>
<span class='hljl-nf'>apply_schema</span><span class='hljl-p'>(</span><span class='hljl-nf'>term</span><span class='hljl-p'>(</span><span class='hljl-sc'>:a</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>&amp;</span><span class='hljl-t'> </span><span class='hljl-nf'>term</span><span class='hljl-p'>(</span><span class='hljl-sc'>:b</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>sch</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
a&#40;continuous&#41; &amp; b&#40;StatsModels.DummyCoding:4→3&#41;
</pre>


<p>Of course if the schema doesn&#39;t have enough information, we&#39;ll get an error:</p>


<pre class='hljl'>
<span class='hljl-nf'>apply_schema</span><span class='hljl-p'>(</span><span class='hljl-nf'>term</span><span class='hljl-p'>(</span><span class='hljl-sc'>:argle_bargle</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>sch</span><span class='hljl-p'>)</span>
</pre>


<pre class="julia-error">
ERROR: KeyError: key argle_bargle not found
</pre>


<h2>Concrete terms generate arrays with <code>modelcols</code></h2>
<p>Any term can generate model columns with <code>modelcols</code>:</p>


<pre class='hljl'>
<span class='hljl-n'>t_ab_concrete</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>apply_schema</span><span class='hljl-p'>(</span><span class='hljl-nf'>term</span><span class='hljl-p'>(</span><span class='hljl-sc'>:a</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>&amp;</span><span class='hljl-t'> </span><span class='hljl-nf'>term</span><span class='hljl-p'>(</span><span class='hljl-sc'>:b</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>sch</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>modelcols</span><span class='hljl-p'>(</span><span class='hljl-n'>t_ab_concrete</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>first</span><span class='hljl-p'>(</span><span class='hljl-n'>df</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>6</span><span class='hljl-p'>))</span>
</pre>


<pre class="output">
6×3 Array&#123;Float64,2&#125;:
 0.0        0.0        0.0     
 0.0525262  0.0        0.0     
 0.0        0.0619198  0.0     
 0.0        0.0        0.308941
 0.0        0.0        0.0     
 0.490118   0.0        0.0
</pre>


<p>Compare with:</p>


<pre class='hljl'>
<span class='hljl-n'>f_concrete</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>apply_schema</span><span class='hljl-p'>(</span><span class='hljl-n'>f</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>sch</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nd'>@show</span><span class='hljl-t'> </span><span class='hljl-n'>t_ab_concrete_formula</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>f_concrete</span><span class='hljl-oB'>.</span><span class='hljl-n'>rhs</span><span class='hljl-oB'>.</span><span class='hljl-n'>terms</span><span class='hljl-p'>[</span><span class='hljl-k'>end</span><span class='hljl-p'>]</span>
</pre>


<pre class="output">
t_ab_concrete_formula &#61; f_concrete.rhs.terms&#91;end&#93; &#61; a &amp; b
</pre>



<pre class='hljl'>
<span class='hljl-nf'>modelcols</span><span class='hljl-p'>(</span><span class='hljl-n'>t_ab_concrete_formula</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>first</span><span class='hljl-p'>(</span><span class='hljl-n'>df</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>6</span><span class='hljl-p'>))</span>
</pre>


<pre class="output">
6×3 Array&#123;Float64,2&#125;:
 0.0        0.0        0.0     
 0.0525262  0.0        0.0     
 0.0        0.0619198  0.0     
 0.0        0.0        0.308941
 0.0        0.0        0.0     
 0.490118   0.0        0.0
</pre>


<p>Of course you can generate columns for the whole formula &#40;it returns a tuple of left-hand side, right-hand side columns&#41;:</p>


<pre class='hljl'>
<span class='hljl-n'>y</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>modelcols</span><span class='hljl-p'>(</span><span class='hljl-n'>f_concrete</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>first</span><span class='hljl-p'>(</span><span class='hljl-n'>df</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>6</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-n'>X</span>
</pre>


<pre class="output">
6×8 Array&#123;Float64,2&#125;:
 1.0  0.781543   0.0  0.0  0.0  0.0        0.0        0.0     
 1.0  0.0525262  1.0  0.0  0.0  0.0525262  0.0        0.0     
 1.0  0.0619198  0.0  1.0  0.0  0.0        0.0619198  0.0     
 1.0  0.308941   0.0  0.0  1.0  0.0        0.0        0.308941
 1.0  0.0778339  0.0  0.0  0.0  0.0        0.0        0.0     
 1.0  0.490118   1.0  0.0  0.0  0.490118   0.0        0.0
</pre>


<h3>Predicting based on new data</h3>
<p>Any table with the right columns can be passed to <code>modelcols</code> and the right columns are generated, even if some levels are missing:</p>


<pre class='hljl'>
<span class='hljl-n'>df2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-n'>a</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>rand</span><span class='hljl-p'>(</span><span class='hljl-ni'>5</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>b</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-sc'>:R</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:R</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:Q</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:S</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:R</span><span class='hljl-p'>])</span><span class='hljl-t'>
</span><span class='hljl-nf'>modelcols</span><span class='hljl-p'>(</span><span class='hljl-n'>f_concrete</span><span class='hljl-oB'>.</span><span class='hljl-n'>rhs</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>df2</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
5×8 Array&#123;Float64,2&#125;:
 1.0  0.682272   1.0  0.0  0.0  0.682272   0.0      0.0
 1.0  0.974592   1.0  0.0  0.0  0.974592   0.0      0.0
 1.0  0.75855    0.0  0.0  0.0  0.0        0.0      0.0
 1.0  0.48055    0.0  1.0  0.0  0.0        0.48055  0.0
 1.0  0.0419534  1.0  0.0  0.0  0.0419534  0.0      0.0
</pre>


<h3>Use a named tuple for a single row</h3>
<p>A single row of the model matrix can be generated from a <code>NamedTuple</code> of data:</p>


<pre class='hljl'>
<span class='hljl-n'>data_row</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>a</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nfB'>1.5</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>b</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-sc'>:T</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-nf'>modelcols</span><span class='hljl-p'>(</span><span class='hljl-n'>f_concrete</span><span class='hljl-oB'>.</span><span class='hljl-n'>rhs</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>data_row</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
8-element Array&#123;Float64,1&#125;:
 1.0
 1.5
 0.0
 0.0
 1.0
 0.0
 0.0
 1.5
</pre>


<h2>Get coefficient names for any term with <code>coefnames</code></h2>


<pre class='hljl'>
<span class='hljl-nf'>coefnames</span><span class='hljl-p'>(</span><span class='hljl-n'>f_concrete</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
&#40;&quot;y&quot;, &#91;&quot;&#40;Intercept&#41;&quot;, &quot;a&quot;, &quot;b: R&quot;, &quot;b: S&quot;, &quot;b: T&quot;, &quot;a &amp; b: R&quot;, &quot;a &amp; b: S&quot;, 
&quot;a &amp; b: T&quot;&#93;&#41;
</pre>



<pre class='hljl'>
<span class='hljl-nf'>coefnames</span><span class='hljl-p'>(</span><span class='hljl-n'>f_concrete</span><span class='hljl-oB'>.</span><span class='hljl-n'>rhs</span><span class='hljl-oB'>.</span><span class='hljl-n'>terms</span><span class='hljl-p'>[</span><span class='hljl-k'>end</span><span class='hljl-p'>])</span>
</pre>


<pre class="output">
3-element Array&#123;String,1&#125;:
 &quot;a &amp; b: R&quot;
 &quot;a &amp; b: S&quot;
 &quot;a &amp; b: T&quot;
</pre>



<pre class='hljl'>
<span class='hljl-nf'>coefnames</span><span class='hljl-p'>(</span><span class='hljl-n'>sch</span><span class='hljl-p'>[</span><span class='hljl-nf'>term</span><span class='hljl-p'>(</span><span class='hljl-sc'>:b</span><span class='hljl-p'>)])</span>
</pre>


<pre class="output">
3-element Array&#123;String,1&#125;:
 &quot;b: R&quot;
 &quot;b: S&quot;
 &quot;b: T&quot;
</pre>


<h2>Formula syntax</h2>
<p>The formula syntax is very similar to R, with the exception that an interaction is specified with <code>&amp;</code>, and that some R syntax is not supported by default &#40;<code>^</code>, <code>/</code> outside of MixedModels.jl&#41;.</p>
<h3>Non-special calls</h3>
<p>Any function calls that are not special syntax &#40;<code>&#43;</code>, <code>&amp;</code>, <code>*</code>, and <code>~</code>&#41; are treated as normal julia code, so you can write things like</p>


<pre class='hljl'>
<span class='hljl-n'>f2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nd'>@formula</span><span class='hljl-p'>(</span><span class='hljl-nf'>log</span><span class='hljl-p'>(</span><span class='hljl-n'>y</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>a</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-n'>a</span><span class='hljl-oB'>^</span><span class='hljl-ni'>2</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>*</span><span class='hljl-t'> </span><span class='hljl-n'>b</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
FormulaTerm
Response:
  &#40;y&#41;-&gt;log&#40;y&#41;
Predictors:
  1
  a&#40;unknown&#41;
  &#40;a&#41;-&gt;a ^ 2
  b&#40;unknown&#41;
  a&#40;unknown&#41; &amp; b&#40;unknown&#41;
  &#40;a&#41;-&gt;a ^ 2 &amp; b&#40;unknown&#41;
</pre>



<pre class='hljl'>
<span class='hljl-n'>f2_concrete</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>apply_schema</span><span class='hljl-p'>(</span><span class='hljl-n'>f2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>sch</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
FormulaTerm
Response:
  &#40;y&#41;-&gt;log&#40;y&#41;
Predictors:
  1
  a&#40;continuous&#41;
  &#40;a&#41;-&gt;a ^ 2
  b&#40;StatsModels.DummyCoding:4→3&#41;
  a&#40;continuous&#41; &amp; b&#40;StatsModels.DummyCoding:4→3&#41;
  &#40;a&#41;-&gt;a ^ 2 &amp; b&#40;StatsModels.DummyCoding:4→3&#41;
</pre>



<pre class='hljl'>
<span class='hljl-n'>y2</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>X2</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>modelcols</span><span class='hljl-p'>(</span><span class='hljl-n'>f2_concrete</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>first</span><span class='hljl-p'>(</span><span class='hljl-n'>df</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>5</span><span class='hljl-p'>))</span>
</pre>


<pre class="output">
&#40;&#91;-0.6145083349338837, -0.1982039677011808, -0.0871964775796565, -1.4810173
649294216, -1.6228616185358296&#93;, &#91;1.0 0.7815431037278331 … 0.0 0.0; 1.0 0.0
5252615619035739 … 0.0 0.0; … ; 1.0 0.3089408601705099 … 0.0 0.095444455082
89456; 1.0 0.07783392487892549 … 0.0 0.0&#93;&#41;
</pre>



<pre class='hljl'>
<span class='hljl-n'>y2</span><span class='hljl-t'> </span><span class='hljl-oB'>==</span><span class='hljl-t'> </span><span class='hljl-n'>log</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-n'>df</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-oB'>:</span><span class='hljl-ni'>5</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:y</span><span class='hljl-p'>])</span>
</pre>


<pre class="output">
true
</pre>



<pre class='hljl'>
<span class='hljl-n'>X2</span>
</pre>


<pre class="output">
5×12 Array&#123;Float64,2&#125;:
 1.0  0.781543   0.61081     0.0  0.0  …  0.0       0.0         0.0      
 1.0  0.0525262  0.002759    1.0  0.0     0.002759  0.0         0.0      
 1.0  0.0619198  0.00383406  0.0  1.0     0.0       0.00383406  0.0      
 1.0  0.308941   0.0954445   0.0  0.0     0.0       0.0         0.0954445
 1.0  0.0778339  0.00605812  0.0  0.0     0.0       0.0         0.0
</pre>



<pre class='hljl'>
<span class='hljl-nf'>coefnames</span><span class='hljl-p'>(</span><span class='hljl-n'>f2_concrete</span><span class='hljl-oB'>.</span><span class='hljl-n'>rhs</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
12-element Array&#123;String,1&#125;:
 &quot;&#40;Intercept&#41;&quot; 
 &quot;a&quot;           
 &quot;a ^ 2&quot;       
 &quot;b: R&quot;        
 &quot;b: S&quot;        
 &quot;b: T&quot;        
 &quot;a &amp; b: R&quot;    
 &quot;a &amp; b: S&quot;    
 &quot;a &amp; b: T&quot;    
 &quot;a ^ 2 &amp; b: R&quot;
 &quot;a ^ 2 &amp; b: S&quot;
 &quot;a ^ 2 &amp; b: T&quot;
</pre>


<h3>Advanced: making the ordinary special</h3>
<p>You may have noticed that <code>zercocorr</code> and <code>|</code> were not included in the list of special syntax above.  StatsModels.jl provides a method to add special syntax for the <code>@formula</code> that&#39;s specific to certain models.  This works using the standard Julia techniques of multiple dispatch, by providing methods that intercept <code>apply_schema</code> for particular combinations of functions, schema, and context &#40;model type&#41;, like so:</p>
<pre><code>function StatsModels.apply_schema&#40;
    t::FunctionTerm&#123;typeof&#40;|&#41;&#125;,
    schema::StatsModels.FullRank,
    Mod::Type&#123;&lt;:MixedModel&#125;,
&#41;
    schema &#61; StatsModels.FullRank&#40;schema.schema&#41;
    lhs, rhs &#61; t.args_parsed
    if &#33;StatsModels.hasintercept&#40;lhs&#41; &amp;&amp; &#33;StatsModels.omitsintercept&#40;lhs&#41;
        lhs &#61; InterceptTerm&#123;true&#125;&#40;&#41; &#43; lhs
    end
    lhs, rhs &#61; apply_schema.&#40;&#40;lhs, rhs&#41;, Ref&#40;schema&#41;, Mod&#41;
    RandomEffectsTerm&#40;MatrixTerm&#40;lhs&#41;, rhs&#41;
end</code></pre>
<p>There&#39;s a simpler <a href="https://juliastats.org/StatsModels.jl/stable/internals/#An-example-of-custom-syntax:-poly-1">example in the StatsModels docs</a> which adds a <code>poly&#40;x, n&#41;</code> syntax for polynomial regression.</p>



          <HR/>
          <div class="footer"><p>
          Published from <a href="contrasts-and-formula.jmd">contrasts-and-formula.jmd</a> using
          <a href="http://github.com/mpastell/Weave.jl">Weave.jl</a>
           on 2020-02-18.
          <p></div>


        </div>
      </div>
    </div>
  </BODY>
</HTML>
